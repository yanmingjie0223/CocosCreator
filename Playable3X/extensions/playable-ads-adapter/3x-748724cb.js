"use strict";var e=require("electron"),t=require("child_process"),r=require("os"),o=require("fs"),n=require("path"),a=require("./playable-adapter-core-6d8847fd.js");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,Object.freeze(t)}var s=i(t),l=i(r),u=c(o);const{exec:d,execSync:p}=s.default;var f={run:function(e,t){return d(e,function(e,r,o){t&&t(e,r,o)})},runSync:function(e){try{return{data:p(e).toString(),err:null,stderr:null}}catch(e){return{data:null,err:e.stderr.toString(),stderr:e.stderr.toString()}}}};const g="playable-ads-adapter",h=()=>{const e=`${Editor.Project.path}/.adapterrc`;return o.existsSync(e)?JSON.parse((t=e,o.readFileSync(t).toString(r))):null;var t,r},b=()=>{const e=Editor.Project.path,t="/build",r=h();let o=r?.buildPlatform??"web-mobile";return{projectRootPath:e,projectBuildPath:t,buildPlatform:o,originPkgPath:n.join(e,t,o),adapterBuildConfig:r}},j=()=>{const e=h();return!!e&&(e.skipBuild??!1)};var y=require("path").join(__dirname+"/3x-fb39cc49.js");const m=e=>new Promise((t,r)=>{let o=Editor.App.path;const n=(()=>{const e=l.default.platform();return"win32"===e?"WINDOWS":"darwin"===e?"MAC":e.toUpperCase()})();"MAC"===n?o=o.replace("/Resources/app.asar","/MacOS/CocosCreator"):"WINDOWS"===n?o=(e=>{let t=e;return-1!==t.indexOf("\\")&&(t=t.replace(/\\/g,"/")),t})(o).replace("/resources/app.asar","/CocosCreator.exe"):r(`不支持${n}平台构建`);f.run(`${o} --project ${Editor.Project.path} --build "platform=${e}"`,(e,r,o)=>{console.log(e,r,o),function(){const e=P(`${Editor.Project.path}/build/web-mobile/src`);if(!e)return void console.error("Cannot find settings file!");const t=u.readFileSync(e,"utf-8"),r=JSON.parse(t),o=r.splashScreen;o&&(o.totalTime=0,o.displayWatermark=!1,o.logo.base64="");u.writeFileSync(e,JSON.stringify(r),"utf-8")}(),t()}).stdout.on("data",e=>{console.log(e)})});function P(e){const t=u.readdirSync(e);for(const r of t){const t=n.join(e,r),o=u.statSync(t);if(o&&o.isDirectory()){const e=P(t);if(e)return e}else if(r.includes("settings"))return t}return""}const S=async e=>{console.log(`${g} 进行预构建处理`),console.log(`${g} 跳过预构建处理`)},w=e=>new Promise(async(t,r)=>{const{projectRootPath:o,projectBuildPath:i,adapterBuildConfig:c}=b(),s=n.join(o,i);console.info(`${g} 开始适配，导出平台 ${e.platform}`);const l=(new Date).getTime(),u=()=>{const e=(new Date).getTime();console.log(`${g} 适配完成，共耗时${((e-l)/1e3).toFixed(0)}秒`),t(!0)},d=e=>{console.error("适配失败"),r(e)},p={buildFolderPath:s,adapterBuildConfig:{...c,buildPlatform:e.platform}};try{((e,t,r)=>{const{Worker:o}=require("worker_threads");console.log("支持Worker，将开启子线程适配"),new o(y,{workerData:e}).on("message",({finished:e,msg:o,event:n})=>{"adapter:finished"!==n?console[n.split(":")[1]](o):e?t():r(o)})})(p,u,d)}catch(e){console.log("不支持Worker，将开启主线程适配"),await a.exec3xAdapter(p,{mode:"serial"}),u()}});exports.BUILDER_NAME=g,exports.builder3x=async()=>{try{const{buildPlatform:t,projectRootPath:r,projectBuildPath:o}=b();console.log(`开始构建项目，导出${t}包`);const a=j(),i=n.join(r,o);await S(),a||await m(t),await w({platform:t}),e.shell.openPath(i),console.log("构建完成")}catch(e){console.error(e)}},exports.initBuildFinishedEvent=w,exports.initBuildStartEvent=S;
